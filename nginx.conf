worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout 65;

    server {
        listen 8080;     # Azure REQUIRED
        server_name _;

        root /home/site/wwwroot/public;   # Laravel public folder
        index index.php index.html;

        client_max_body_size 100m;

        # Laravel front controller
        location / {
            try_files $uri $uri/ /index.php?$query_string;
        }

        # PHP-FPM handler (Azure requires socket)
        location ~ \.php$ {
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_pass unix:/tmp/php-fpm.sock;   # <<< CRITICAL FIX
            fastcgi_index index.php;
            fastcgi_intercept_errors on;
        }

        # Cache static assets
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf)$ {
            try_files $uri =404;
            expires 30d;
            access_log off;
        }

        # Allow Let's Encrypt (optional)
        location ^~ /.well-known/acme-challenge/ {
            allow all;
            default_type "text/plain";
            root /home/site/wwwroot/public;
        }

        # Block hidden files
        location ~ /\. {
            deny all;
        }
    }
}
